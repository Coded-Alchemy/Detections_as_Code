name: Build and Test Detections
on:
  push:
    branches: ["main"]
  pull_request: {}

jobs:
  build:
    runs-on: [self-hosted, linux, x64]

    env:
      SPLUNK_USERNAME: ${{ secrets.SPLUNK_USERNAME }}
      SPLUNK_PASSWORD: ${{ secrets.SPLUNK_PASSWORD }}
      SPLUNK_URL: ${{ secrets.SPLUNK_URL }}

    # Timeout to prevent hanging jobs
    timeout-minutes: 15
    
    steps:
    # Project Checkout
    - name: Checkout
      uses: actions/checkout@v4

    # Verify secrets exist before continuing
    - name: Verify Required Secrets
      run: |
        echo "Checking secrets..."
        if [ -z "${{ secrets.SPLUNK_URL }}" ]; then
          echo "ERROR: SPLUNK_URL secret is not set in GitHub!"
          exit 1
        fi
        if [ -z "${{ secrets.SPLUNK_USERNAME }}" ]; then
          echo "ERROR: SPLUNK_USERNAME secret is not set!"
          exit 1
        fi
        if [ -z "${{ secrets.SPLUNK_PASSWORD }}" ]; then
          echo "ERROR: SPLUNK_PASSWORD secret is not set!"
          exit 1
        fi
        echo "All secrets are configured"

    # Clean workspace before starting
    - name: Clean Workspace
      run: |
        rm -rf generated/

    # Install and configure Sigma with Splunk plugin
    - name: Install Sigma
      run: |
        python3 -m pip install --upgrade pip
        python3 -m pip install sigma-cli
        sigma plugin install splunk

    # Convert Sigma rules into SPL(Splunk Search Processing Language)
    - name: Convert Sigma to SPL
      run: | 
        mkdir -p generated/splunk
        
        for rule_file in rules/*.yml; do
          if [ -f "$rule_file" ]; then
            file_name=$(filename "$rule_file" .yml)
            echo "Converting $rule_file..."
            sigma convert --target splunk --pipeline splunk_windows "$rule_file" > "generated/splunk/${file_name}.spl"
            echo "Created generated/splunk/${file_name}.spl
          fi
        done
        
        echo "Generated files:"
        ls -lh generated/splunk/
    
    # Save SPL artifact with the name spl-detections to the generated/splunk directory
    - name: Upload SPL as an artifact
      uses: actions/upload-artifact@v4
      with:
        name: spl-detections
        path: generated/splunk

    # Debugging/Logging
    - name: Debug Environment Variables
      run: |
        echo "Checking if secrets are set..."
        echo "SPLUNK_URL is set: ${{ secrets.SPLUNK_URL != '' }}"
        echo "SPLUNK_URL length: ${#TF_VAR_splunk_url}"
        echo "First 10 chars of URL: ${TF_VAR_splunk_url:0:10}"
      env:
        TF_VAR_splunk_url: ${{ secrets.SPLUNK_URL }}

    # Install Terraform
    - name: Install Terraform
      uses: hashicorp/setup-terraform@v3

    # Terraform formatting check
    - name: Terraform Format
      working-directory: terraform
      run: terraform fmt -check

    # Initialize Terraform
    - name: Terraform Init
      working-directory: terraform
      run: terraform init

    # Test Terraform before deployment
    - name: Terraform Validate
      working-directory: terraform
      run: terraform validate

    # Terraform plan
    - name: Terraform Plan
      id: plan
      working-directory: terraform
      env:
        TF_VAR_splunk_url: ${{ secrets.SPLUNK_URL }}
        TF_VAR_splunk_username: ${{ secrets.SPLUNK_USERNAME }}
        TF_VAR_splunk_password: ${{ secrets.SPLUNK_PASSWORD }}
        TF_VAR_alert_email: ${{ secrets.ALERT_EMAIL }}
        TF_VAR_insecure_skip_verify: "true"
      run: terraform plan

    # Terraform apply (only on main branch)
    - name: Terraform Apply
      if: github.ref == 'refs/heads/main'
      working-directory: terraform
      env:
        TF_VAR_splunk_url: ${{ secrets.SPLUNK_URL }}
        TF_VAR_splunk_username: ${{ secrets.SPLUNK_USERNAME }}
        TF_VAR_splunk_password: ${{ secrets.SPLUNK_PASSWORD }}
        TF_VAR_alert_email: ${{ secrets.ALERT_EMAIL }}
        TF_VAR_insecure_skip_verify: "true"
      run: terraform apply -auto-approve

    # Clean up
    - name: Cleanup
      if: always()
      run: |
       rm -rf generated/
       rm -rf .terraform/