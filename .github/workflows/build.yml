name: Build and Test Detections
on:
  push:
    branches: ["main"]
  pull_request: {}

jobs:
  build:
    runs-on: [self-hosted, linux, x64]

    env:
      SPLUNK_USERNAME: ${{ secrets.SPLUNK_USERNAME }}
      SPLUNK_PASSWORD: ${{ secrets.SPLUNK_PASSWORD }}
      SPLUNK_URL: ${{ secrets.SPLUNK_URL }}

    # Timeout to prevent hanging jobs
    # timeout-minutes: 15
    
    steps:
    # Project Checkout
    - name: Checkout
      uses: actions/checkout@v4

    # Clean workspace before starting
    - name: Clean Workspace
      run: |
        rm -rf generated/

    # Install and configure Sigma with Splunk plugin
    #- name: Install Sigma
    #  run: |
    #    python3 -m pip install --upgrade pip
    #    python3 -m pip install sigma-cli
    #    sigma plugin install splunk

    # Convert Sigma rules into SPL
    - name: Convert Sigma to SPL
      run: | 
        set -e
        mkdir -p generated/splunk
        
        echo "Converting Sigma rules to SPL..."
        rule_count=0
        
        while IFS= read -r rule_file; do
          file_name=$(basename "$rule_file" .yml)
          
          if sigma convert --target splunk --pipeline splunk_windows "$rule_file" > "generated/splunk/${file_name}.spl" 2>&1; then
            if [ -s "generated/splunk/${file_name}.spl" ]; then
              echo "${file_name}.spl"
              rule_count=$((rule_count + 1))
            else
              echo "${file_name}.spl is empty"
              exit 1
            fi
          else
            echo "Failed to convert $rule_file"
            exit 1
          fi
        done < <(find rules -type f -name "*.yml")
        
        if [ "$rule_count" -eq 0 ]; then
          echo "ERROR: No rules converted"
          exit 1
        fi
        
        echo "Converted $rule_count rule(s)"
        ls -lh generated/splunk/

    # Save SPL artifact with the name spl-detections to the generated/splunk directory
    - name: Upload SPL as an artifact
      uses: actions/upload-artifact@v4
      with:
        name: spl-detections
        path: generated/splunk

    # Install Terraform
    - name: Install Terraform
      uses: hashicorp/setup-terraform@v3

    # Terraform formatting check
    - name: Terraform Format
      working-directory: terraform
      run: terraform fmt -check

    # Initialize Terraform
    - name: Terraform Init
      working-directory: terraform
      env:
        TF_VAR_splunk_url: ${{ secrets.SPLUNK_URL }}
        TF_VAR_splunk_username: ${{ secrets.SPLUNK_USERNAME }}
        TF_VAR_splunk_password: ${{ secrets.SPLUNK_PASSWORD }}
        TF_VAR_alert_email: ${{ secrets.ALERT_EMAIL }}
        TF_VAR_insecure_skip_verify: "true"
      run: terraform init

    # Test Terraform before deployment
    - name: Terraform Validate
      working-directory: terraform
      env:
        TF_VAR_splunk_url: ${{ secrets.SPLUNK_URL }}
        TF_VAR_splunk_username: ${{ secrets.SPLUNK_USERNAME }}
        TF_VAR_splunk_password: ${{ secrets.SPLUNK_PASSWORD }}
        TF_VAR_alert_email: ${{ secrets.ALERT_EMAIL }}
        TF_VAR_insecure_skip_verify: "true"
      run: terraform validate

    # Terraform plan
    - name: Terraform Plan
      id: plan
      working-directory: terraform
      env:
        TF_VAR_splunk_url: ${{ secrets.SPLUNK_URL }}
        TF_VAR_splunk_username: ${{ secrets.SPLUNK_USERNAME }}
        TF_VAR_splunk_password: ${{ secrets.SPLUNK_PASSWORD }}
        TF_VAR_alert_email: ${{ secrets.ALERT_EMAIL }}
        TF_VAR_insecure_skip_verify: "true"
      run: |
        terraform plan -out=tfplan
        terraform show tfplan

    # Terraform apply
    - name: Terraform Apply
      working-directory: terraform
      env:
        TF_VAR_splunk_url: ${{ secrets.SPLUNK_URL }}
        TF_VAR_splunk_username: ${{ secrets.SPLUNK_USERNAME }}
        TF_VAR_splunk_password: ${{ secrets.SPLUNK_PASSWORD }}
        TF_VAR_alert_email: ${{ secrets.ALERT_EMAIL }}
        TF_VAR_insecure_skip_verify: "true"
      run: |
        terraform apply tfplan
        
        echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Deployed Detection Rules:**" >> $GITHUB_STEP_SUMMARY
        terraform output -json deployed_detections | jq -r 'to_entries[] | "- **\(.value.name)** (Severity: \(.value.severity))"' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Total Rules Deployed:** $(terraform output -raw detection_count)" >> $GITHUB_STEP_SUMMARY

# Clean up
    - name: Cleanup
      if: always()
      run: |
        echo "Cleaning up temporary files..."
        rm -rf terraform/.terraform/
        rm -f terraform/tfplan
        rm -f terraform/terraform.tfstate.backup